tag:
type: txt
help: Set wireless modem interface
comp_help: Enter wireless modem interface name (ppp0 - ppp999)
syntax:expression: pattern $VAR(@) "^ppp[0-9]+$" ; "Must be (ppp0 - ppp999)"
delete: touch /tmp/wirelessmodem-$VAR(@).del
end: if [ -f /var/run/$VAR(@).pid ]; then
         pid=$(cat /var/run/$VAR(@).pid);
         sudo kill $pid;
         while [ -d /proc/$pid ]; do
           sleep 1;
         done;
     fi;

     if [ -f /tmp/wirelessmodem-$VAR(@).del ]; then
         rm -f /tmp/wirelessmodem-$VAR(@).del
         exit 0;
     fi;

     tmpfile="/tmp/wirelessmodem-$VAR(@)"
     rm -f $tmpfile; 

     if [ -z "$(ip link show $VAR(@) 2>&1 | grep -v "^Device")" ]; then
       if [ -n "$VAR(./backup)" ]; then
	 if [ -n "$VAR(./backup/distance/@)" ]; then 
	   metric="$VAR(./backup/distance/@)"
	 else
	   metric=10
	 fi
         echo ipparam $metric >> $tmpfile;    
       fi;

       if [ -n "$VAR(./ondemand)" ]; then
         echo demand >> $tmpfile;
       fi;

       if [ -z "$VAR(./no-dns)" ]; then
         echo usepeerdns >> $tmpfile;
       fi;

       if [ -n "$VAR(./mtu/@)" ]; then
         echo mtu $VAR(./mtu/@) >> $tmpfile;
       fi;

       if [ -n "$VAR(./device/@)" ]; then
         device=$VAR(./device/@);
       else 
	 device='ttyUSB0';
       fi;
       echo /dev/$device >> $tmpfile;

       unit=$(echo $VAR(@) | sed 's/ppp//');

       # setup the peers file
       echo -e "lcp-echo-failure 0\n115200" >> $tmpfile;
       echo -e "debug\nnodefaultroute\nipcp-max-failure 4" >> $tmpfile;
       echo -e "ipcp-accept-local\nipcp-accept-remote\nnoauth\ncrtscts" >> $tmpfile;
       echo -e "lock\npersist\nunit $unit" >> $tmpfile;

       if [ -n "$VAR(./network/@)" ]; then
         network=$VAR(./network/@);
       else
         network='att';
       fi;

       echo connect \'/usr/sbin/chat -v -t6 -f /opt/vyatta/share/ppp/network/$network\' >> $tmpfile;

       sudo rm -f /var/run/$VAR(@).log /etc/ppp/peers/$VAR(@).wirelessmodem
       sudo mv $tmpfile /etc/ppp/peers/$VAR(@).wirelessmodem
       sudo sh -c "pppd call $VAR(@).wirelessmodem > /var/run/$VAR(@).log";
     else 
       echo '  PPP interface $VAR(@) already exists!'
       echo '  Please choose another interface name';
       echo '  for the wirelessmodem.';
       exit 1;
     fi;  
